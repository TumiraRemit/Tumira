<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tumira - Send Money to Zimbabwe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Base styles for body to cover full screen and prevent horizontal scrolling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light gray background */
            display: flex;
            flex-direction: column; /* Stack content vertically for smaller screens */
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Full viewport height */
            width: 100vw; /* Full viewport width */
            padding: 1rem; /* Responsive padding */
            box-sizing: border-box;
            overflow-x: hidden; /* Prevent horizontal scrolling */
        }

        /* Custom styles for better aesthetics and responsiveness */
        .card {
            background-color: #ffffff;
            border-radius: 1rem; /* Rounded corners */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 2rem; /* Default padding */
            width: 100%;
            max-width: 600px; /* Max width for larger screens */
            margin-top: 1rem; /* Add some top margin */
            margin-bottom: 1rem; /* Add some bottom margin */
            transition: all 0.3s ease-in-out; /* Smooth transitions for card */
        }
        @media (min-width: 640px) { /* Small screens (sm) */
            body {
                padding: 2rem;
            }
            .card {
                padding: 2.5rem;
            }
        }
        @media (min-width: 768px) { /* Medium screens (md) */
            .card {
                padding: 3rem;
            }
        }

        .input-field {
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db; /* Light gray border */
            border-radius: 0.5rem; /* Rounded corners for inputs */
            width: 100%;
            font-size: 1rem;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .input-field:focus {
            outline: none;
            border-color: #3b82f6; /* Blue on focus */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25); /* Light blue shadow on focus */
        }

        .btn-primary {
            background-color: #3b82f6; /* Blue background */
            color: #ffffff;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
            width: 100%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:hover {
            background-color: #2563eb; /* Darker blue on hover */
            transform: translateY(-2px); /* Lift slightly */
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary {
            background-color: #6b7280; /* Gray background */
            color: #ffffff;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
            width: 100%;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.08);
        }
        .btn-secondary:hover {
            background-color: #4b5563; /* Darker gray on hover */
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.12);
        }
        .btn-secondary:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }

        .section-title {
            font-size: 1.5rem; /* Larger text for titles */
            font-weight: 700; /* Bold */
            color: #1f2937; /* Dark gray text */
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e5e7eb; /* Light gray line */
            padding-bottom: 0.75rem; /* More padding below line */
            text-align: center; /* Center align section titles */
        }
        @media (min-width: 640px) {
            .section-title {
                font-size: 1.75rem;
            }
        }

        .message-box {
            background-color: #dbeafe; /* Light blue */
            color: #1e40af; /* Dark blue text */
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1.5rem; /* More margin */
            display: none; /* Hidden by default */
            text-align: center;
            font-weight: 500;
            transition: all 0.3s ease-in-out;
        }
        .error-message {
            background-color: #fee2e2; /* Light red */
            color: #dc2626; /* Dark red text */
        }
        .success-message {
            background-color: #d1fae5; /* Light green */
            color: #065f46; /* Dark green text */
        }

        .tab-button {
            padding: 0.75rem 1rem; /* Adjusted padding */
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            background-color: #e5e7eb;
            color: #4b5563;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out, transform 0.1s ease-in-out;
            flex-grow: 1; /* Allow buttons to grow */
            text-align: center;
            white-space: nowrap; /* Prevent text wrapping */
        }
        .tab-button:hover {
            transform: translateY(-1px);
        }
        .tab-button.active {
            background-color: #3b82f6;
            color: #ffffff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .tab-button.active:hover {
            transform: translateY(0); /* No lift when active */
        }
        /* Responsive tab buttons */
        .tab-buttons-container {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            gap: 0.5rem; /* Space between buttons */
            justify-content: center;
            margin-bottom: 2rem;
        }
        @media (min-width: 640px) {
            .tab-buttons-container {
                flex-wrap: nowrap; /* No wrapping on larger screens */
                gap: 0.75rem;
            }
            .tab-button {
                padding: 0.75rem 1.5rem;
            }
        }

        .tab-content {
            display: none;
            padding-top: 1rem; /* Padding for content below tabs */
        }
        .tab-content.active {
            display: block;
        }

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 28px; /* Slightly larger spinner */
            height: 28px;
            animation: spin 1s linear infinite;
            margin: 1.5rem auto; /* More margin */
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Adjust font sizes for general text content */
        p, ul, li {
            font-size: 0.95rem;
            line-height: 1.6;
        }
        @media (min-width: 640px) {
            p, ul, li {
                font-size: 1rem;
            }
        }

        /* User Info / Auth Section styling */
        #user-info-section {
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            border-radius: 0.75rem; /* Slightly more rounded */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            text-align: center;
            background-color: #e0f2fe; /* Light blue background for welcome */
        }
        #auth-section {
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            text-align: center;
            background-color: #f5f5f5; /* Light gray for auth prompt */
        }

        #user-id-display, #user-id-display-anon {
            word-break: break-all; /* Ensure long IDs wrap */
            font-size: 0.75rem;
            margin-top: 0.5rem;
            display: none; /* Hidden by default as per new requirements */
        }

        /* Modal for Terms and Conditions */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; /* Ensure it's on top */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            max-width: 90%; /* Responsive width */
            max-height: 80vh; /* Responsive height */
            overflow-y: auto; /* Scrollable content */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        .modal-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }
        .modal-close-btn:hover {
            color: #1f2937;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile, updatePassword, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- START: PASTE YOUR FIREBASE CONFIG HERE ---
        // Get your Firebase project's config from Firebase Console -> Project settings -> Your apps -> Web app
        const firebaseConfig = {
            apiKey: "AIzaSyA_Sy72josAAuBc3N8cvgEo2j1Nd0j_uZs",
            authDomain: "tumiraremit-38564.firebaseapp.com",
            projectId: "tumiraremit-38564",
            storageBucket: "tumiraremit-38564.firebasestorage.app",
            messagingSenderId: "193421797298",
            appId: "1:193421797298:web:0b3ff6e7d06b0df45d66ab",
            measurementId: "G-0GZ81MDLX7"
        };

        // --- END: PASTE YOUR FIREBASE CONFIG HERE ---

        // The appId used for Firestore collection paths
        // This should match the appId in your firebaseConfig
        const appId = firebaseConfig.appId || 'default-app-id';

        // Global variables for Firebase (will be initialized in script)
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.currentUserId = null;
        window.isAuthReady = false; // Flag to indicate if auth state is known

        try {
            window.firebaseApp = initializeApp(firebaseConfig);
            window.db = getFirestore(window.firebaseApp);
            window.auth = getAuth(window.firebaseApp);

            // Listen for authentication state changes
            onAuthStateChanged(window.auth, async (user) => {
                const sendMoneySection = document.getElementById('sendMoneySection');
                const authSection = document.getElementById('auth-section');
                const userInfoSection = document.getElementById('user-info-section');
                const sendMoneyButton = document.getElementById('toggleRemittanceFormBtn');
                const estimateFeesSection = document.getElementById('estimateFeesSection');
                const authForm = document.getElementById('authForm');
                const manageProfileSection = document.getElementById('manageProfileSection');
                const updateProfileNameInput = document.getElementById('updateProfileName');


                if (user) {
                    window.currentUserId = user.uid;
                    console.log("User is signed in:", user.uid);
                    
                    authSection.classList.add('hidden');
                    userInfoSection.classList.remove('hidden');
                    sendMoneySection.classList.remove('hidden'); // Show Send Money section for logged-in users
                    estimateFeesSection.classList.add('hidden'); // Hide estimate fees when logged in (can be re-enabled if desired)
                    authForm.classList.add('hidden'); // Hide auth form when logged in
                    manageProfileSection.classList.remove('hidden'); // Show manage profile section

                    // Fetch user profile if it exists
                    const userData = await fetchUserProfile(user.uid);
                    if (userData) {
                        updateProfileNameInput.value = userData.name || ''; // Populate manage profile name field
                    }

                } else {
                    window.currentUserId = null;
                    console.log("No user is signed in.");
                    
                    authSection.classList.remove('hidden');
                    userInfoSection.classList.add('hidden');
                    sendMoneySection.classList.add('hidden'); // Hide Send Money section if not logged in
                    document.getElementById('remittanceForm').classList.add('hidden'); // Ensure form is hidden
                    sendMoneyButton.textContent = 'Send Money'; // Reset button text
                    estimateFeesSection.classList.remove('hidden'); // Show estimate fees when logged out
                    authForm.classList.remove('hidden'); // Show auth form when logged out
                    manageProfileSection.classList.add('hidden'); // Hide manage profile section

                    // Attempt anonymous sign-in if no custom token is provided
                    const __initial_auth_token = ""; // Placeholder for local testing, Canvas will override
                    if (typeof __initial_auth_token === 'undefined' || __initial_auth_token === "") {
                        try {
                            await signInAnonymously(window.auth);
                            console.log("Signed in anonymously for fee estimation.");
                        } catch (error) {
                            console.error("Error signing in anonymously:", error);
                        }
                    }
                }
                window.isAuthReady = true; // Auth state is now known
                console.log("Firebase Auth Ready:", window.isAuthReady);
            });

            // Sign in with custom token if available (for Canvas environment)
            const __initial_auth_token = ""; // Placeholder for local testing, Canvas will override
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token !== "") {
                signInWithCustomToken(window.auth, __initial_auth_token)
                    .then(() => console.log("Signed in with custom token."))
                    .catch(error => console.error("Error signing in with custom token:", error));
            } else {
                console.log("No initial auth token provided or token is empty. Will rely on onAuthStateChanged for sign-in.");
            }

        } catch (error) {
            console.error("Error initializing Firebase:", error);
            document.getElementById('responseMessage').textContent = `Firebase initialization error: ${error.message}`;
            document.getElementById('responseMessage').classList.add('error-message');
            document.getElementById('responseMessage').style.display = 'block';
        }

        // Function to fetch user profile from Firestore
        async function fetchUserProfile(userId) {
            if (!window.db || !userId) return null;
            const userDocRef = doc(window.db, `artifacts/${appId}/users/${userId}/profiles`, 'userProfile');
            try {
                const docSnap = await getDoc(userDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('displayUserName').textContent = data.name || 'User';
                    document.getElementById('displayUserEmail').textContent = data.email || '';
                    console.log("User profile fetched:", data);
                    return data;
                } else {
                    console.log("No user profile found for:", userId);
                    document.getElementById('displayUserName').textContent = 'New User';
                    document.getElementById('displayUserEmail').textContent = '';
                    return null;
                }
            } catch (error) {
                console.error("Error fetching user profile:", error);
                return null;
            }
        }

        // Expose functions to global scope for HTML event listeners
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.signOut = signOut;
        window.setDoc = setDoc;
        window.doc = doc;
        window.collection = collection;
        window.getDoc = getDoc;
        window.getFirestore = getFirestore;
        window.getAuth = getAuth;
        window.appId = appId; // Make appId available globally
        window.updateProfile = updateProfile;
        window.updatePassword = updatePassword;
        window.reauthenticateWithCredential = reauthenticateWithCredential;
        window.EmailAuthProvider = EmailAuthProvider;
    </script>
</head>
<body class="antialiased">
    <div class="card">
        <h1 class="text-4xl font-extrabold text-center text-gray-900 mb-8 sm:text-5xl">Tumira</h1>
        <p class="text-center text-gray-600 mb-8 text-base sm:text-lg">Send money securely and easily to Zimbabwe.</p>

        <div class="tab-buttons-container">
            <button class="tab-button active" data-tab="home">Home</button>
            <button class="tab-button" data-tab="account">Account</button>
            <button class="tab-button" data-tab="fees">Fees</button>
            <button class="tab-button" data-tab="about">About Us</button>
        </div>

        <div id="home" class="tab-content active">
            <div id="user-info-section" class="mb-6 p-4 bg-gray-50 rounded-lg shadow-sm hidden">
                <p class="text-sm font-semibold text-gray-700">Welcome, <span id="displayUserName" class="font-bold text-blue-700"></span>!</p>
                <p class="text-xs text-gray-500" id="displayUserEmail"></p>
                <button id="logoutButton" class="btn-secondary mt-3 text-sm py-2 px-4">Logout</button>
            </div>

            <div id="auth-section" class="mb-6 p-4 bg-gray-50 rounded-lg shadow-sm">
                <p class="text-base text-gray-700 text-center font-medium">To enjoy our full features, please:</p>
                <div class="mt-4 flex flex-col sm:flex-row gap-3 justify-center">
                    <button class="btn-primary sm:w-auto" onclick="document.querySelector('.tab-button[data-tab=\'account\']').click();">Log In or Create a Tumira Account</button>
                </div>
            </div>

            <div id="sendMoneySection" class="hidden">
                <h2 class="section-title">Ready to Send Money?</h2>
                <p class="text-center text-gray-600 mb-6">Click the button below to start your transfer.</p>
                <button id="toggleRemittanceFormBtn" class="btn-primary">Send Money</button>

                <form id="remittanceForm" class="space-y-6 mt-6 hidden">
                    <div class="space-y-4">
                        <h3 class="section-title">Your Details</h3>
                        <div>
                            <label for="senderName" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                            <input type="text" id="senderName" name="senderName" placeholder="Your Full Name" class="input-field" required>
                        </div>
                        <div>
                            <label for="senderPhone" class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                            <input type="tel" id="senderPhone" name="senderPhone" placeholder="+1234567890" class="input-field" required>
                        </div>
                        <div>
                            <label for="senderEmail" class="block text-sm font-medium text-gray-700 mb-1">Email Address (Optional)</label>
                            <input type="email" id="senderEmail" name="senderEmail" placeholder="you@example.com" class="input-field">
                        </div>
                    </div>

                    <div class="space-y-4 pt-6 border-t border-gray-200">
                        <h3 class="section-title">Recipient Details</h3>
                        <div>
                            <label for="recipientName" class="block text-sm font-medium text-gray-700 mb-1">Recipient Full Name</label>
                            <input type="text" id="recipientName" name="recipientName" placeholder="Recipient's Full Name" class="input-field" required>
                        </div>
                        <div>
                            <label for="recipientPhone" class="block text-sm font-medium text-gray-700 mb-1">Recipient Phone Number (Zimbabwe)</label>
                            <input type="tel" id="recipientPhone" name="recipientPhone" placeholder="+2637xxxxxxxxx" class="input-field" required>
                        </div>
                        <div>
                            <label for="payoutMethod" class="block text-sm font-medium text-gray-700 mb-1">Payout Method</label>
                            <select id="payoutMethod" name="payoutMethod" class="input-field" required>
                                <option value="">Select Payout Method</option>
                                <option value="mobile_money">Mobile Money (EcoCash, OneMoney)</option>
                                <option value="bank_transfer">Bank Transfer (USD)</option>
                                <option value="cash_pickup">Cash Pickup (USD or ZWL)</option>
                            </select>
                        </div>
                        <div id="bankDetails" class="space-y-4 hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Bank Details</label>
                            <div>
                                <input type="text" id="bankName" name="bankName" placeholder="Bank Name" class="input-field">
                            </div>
                            <div>
                                <input type="text" id="accountNumber" name="accountNumber" placeholder="Account Number" class="input-field">
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4 pt-6 border-t border-gray-200">
                        <h3 class="section-title">Transaction Details</h3>
                        <div>
                            <label for="amountSend" class="block text-sm font-medium text-gray-700 mb-1">Amount to Send (USD)</label>
                            <input type="number" id="amountSend" name="amountSend" placeholder="e.g., 100" min="1" step="0.01" class="input-field" required>
                        </div>
                        <div>
                            <label for="amountReceive" class="block text-sm font-medium text-gray-700 mb-1">Recipient Will Receive</label>
                            <input type="text" id="amountReceive" name="amountReceive" value="Calculated automatically" class="input-field bg-gray-100 cursor-not-allowed" readonly>
                        </div>
                        <div>
                            <label for="purpose" class="block text-sm font-medium text-gray-700 mb-1">Purpose of Transfer</label>
                            <textarea id="purpose" name="purpose" rows="3" placeholder="e.g., Family support, Gift, Business" class="input-field resize-y"></textarea>
                        </div>
                    </div>

                    <button type="submit" class="btn-primary">Send Money Now</button>
                    <div id="responseMessage" class="message-box"></div>
                </form>
            </div>

            <div id="estimateFeesSection" class="mt-8">
                <h2 class="section-title">Estimate Fees for an Amount of Your Choice</h2>
                <p class="text-center text-gray-600 mb-6">See how much your recipient could get before you send.</p>
                <button id="toggleEstimateFeesFormBtn" class="btn-secondary">Estimate Fees</button>

                <div id="feeEstimationForm" class="space-y-4 mt-6 hidden">
                    <div>
                        <label for="estimateAmount" class="block text-sm font-medium text-gray-700 mb-1">Amount to Estimate (USD)</label>
                        <input type="number" id="estimateAmount" placeholder="e.g., 50" min="1" step="0.01" class="input-field">
                    </div>
                    <div>
                        <label for="estimatePayoutMethod" class="block text-sm font-medium text-gray-700 mb-1">Desired Payout Method</label>
                        <select id="estimatePayoutMethod" class="input-field">
                            <option value="">Select Payout Method</option>
                            <option value="mobile_money">Mobile Money (EcoCash, OneMoney)</option>
                            <option value="bank_transfer">Bank Transfer (USD)</option>
                            <option value="cash_pickup">Cash Pickup (USD or ZWL)</option>
                        </select>
                    </div>
                    <div id="estimatedResult" class="message-box success-message" style="display: none;"></div>
                </div>
            </div>
        </div>

        <div id="account" class="tab-content">
            <div id="authForm" class="space-y-4">
                <h2 class="section-title">Create or Log In to Your Account</h2>
                <div>
                    <label for="accountName" class="block text-sm font-medium text-gray-700 mb-1">Your Name</label>
                    <input type="text" id="accountName" name="accountName" placeholder="Your Name" class="input-field">
                </div>
                <div>
                    <label for="accountEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="accountEmail" name="accountEmail" placeholder="your@email.com" class="input-field" required>
                </div>
                <div>
                    <label for="accountPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="accountPassword" name="accountPassword" placeholder="Minimum 6 characters" class="input-field" required>
                </div>
                <button id="createAccountBtn" class="btn-primary">Create New Account</button>
                <button id="loginAccountBtn" class="btn-secondary">Log In</button>
                <div id="accountMessage" class="message-box"></div>
                <div class="loading-spinner" id="authSpinner"></div>
            </div>

            <div id="manageProfileSection" class="space-y-6 hidden">
                <h2 class="section-title">Manage Your Profile</h2>

                <div class="space-y-4">
                    <h3 class="font-semibold text-lg text-gray-800">Update Your Name</h3>
                    <div>
                        <label for="updateProfileName" class="block text-sm font-medium text-gray-700 mb-1">Your Name</label>
                        <input type="text" id="updateProfileName" name="updateProfileName" placeholder="Your Updated Name" class="input-field">
                    </div>
                    <button id="updateProfileBtn" class="btn-primary">Update Profile</button>
                    <div id="profileUpdateMessage" class="message-box"></div>
                    <div class="loading-spinner" id="profileSpinner"></div>
                </div>

                <div class="space-y-4 pt-6 border-t border-gray-200">
                    <h3 class="font-semibold text-lg text-gray-800">Change Your Password</h3>
                    <div>
                        <label for="currentPassword" class="block text-sm font-medium text-gray-700 mb-1">Current Password</label>
                        <input type="password" id="currentPassword" name="currentPassword" class="input-field">
                    </div>
                    <div>
                        <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-1">New Password (min 6 characters)</label>
                        <input type="password" id="newPassword" name="newPassword" class="input-field">
                    </div>
                    <div>
                        <label for="confirmNewPassword" class="block text-sm font-medium text-gray-700 mb-1">Confirm New Password</label>
                        <input type="password" id="confirmNewPassword" name="confirmNewPassword" class="input-field">
                    </div>
                    <button id="changePasswordBtn" class="btn-secondary">Change Password</button>
                    <div id="passwordChangeMessage" class="message-box"></div>
                    <div class="loading-spinner" id="passwordSpinner"></div>
                </div>
            </div>
        </div>

        <div id="fees" class="tab-content">
            <h2 class="section-title">Our Fees</h2>
            <p class="text-gray-700 mb-4">At Tumira, we strive to offer transparent and competitive fees to ensure your loved ones receive as much as possible.</p>
            <ul class="list-disc list-inside text-gray-700 space-y-2">
                <li><strong>Fixed Fee:</strong> A flat fee of $3.00 USD applies to all transfers, regardless of the amount.</li>
                <li><strong>Exchange Rate Margin:</strong> Our exchange rates are competitive and include a small margin. You'll always see the exact amount your recipient will receive before confirming the transfer.</li>
                <li><strong>No Hidden Charges:</strong> What you see is what you pay. We believe in full transparency.</li>
            </ul>
            <p class="text-gray-600 mt-4 text-sm">Please note that recipient's mobile money or bank may apply their own charges for receiving funds, which are outside of Tumira's control.</p>
        </div>

        <div id="about" class="tab-content">
            <h2 class="section-title">About Tumira</h2>
            <p class="text-gray-700 mb-4">Tumira is dedicated to simplifying money transfers to Zimbabwe, making it easier and more affordable for the diaspora to support their families and communities back home.</p>
            <h3 class="font-semibold text-lg text-gray-800 mb-2">Our Founder: Barachel</h3>
            <p class="text-gray-700 mb-4">Tumira was founded by Barachel, a visionary with a deep understanding of the challenges faced by individuals sending money across borders. Driven by a passion for financial inclusion and a desire to connect families, Barachel embarked on a mission to create a remittance service that is not only efficient and secure but also truly puts the user first. His commitment to leveraging technology for social good is at the heart of Tumira's mission.</p>
            <p class="text-gray-700">We are committed to providing a reliable, fast, and user-friendly platform for all your remittance needs.</p>
        </div>

        <div class="mt-8 text-center text-gray-500 text-sm">
            &copy; 2024 Tumira. All rights reserved. |
            <a href="#" id="viewTermsLink" class="text-blue-600 hover:underline">Terms and Conditions</a>
        </div>
    </div>

    <div id="termsModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" id="closeTermsModal">&times;</button>
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Terms and Conditions</h2>
            <div class="text-gray-700 text-sm md:text-base space-y-4">
                <p>Welcome to Tumira! By using our website and services, you agree to comply with and be bound by the following terms and conditions of use. Please review these terms carefully.</p>

                <h3 class="font-semibold text-lg">1. Acceptance of Terms</h3>
                <p>By accessing or using Tumira (the "Service"), you agree to be bound by these Terms and Conditions ("Terms"), our Privacy Policy, and all applicable laws and regulations. If you do not agree with any of these terms, you are prohibited from using or accessing this site.</p>

                <h3 class="font-semibold text-lg">2. Service Description</h3>
                <p>Tumira provides an online platform that facilitates money transfers from users to recipients in Zimbabwe. Our service is designed to be secure, fast, and transparent. We are not a bank or financial institution but a payment service provider.</p>

                <h3 class="font-semibold text-lg">3. User Responsibilities</h3>
                <ul class="list-disc list-inside space-y-1 ml-4">
                    <li>You must provide accurate, current, and complete information when registering and using our Service.</li>
                    <li>You are responsible for maintaining the confidentiality of your account password and for all activities that occur under your account.</li>
                    <li>You must only send money to recipients you know and trust. Tumira is not responsible for disputes with recipients.</li>
                    <li>You must comply with all applicable laws and regulations, including anti-money laundering (AML) and counter-terrorism financing (CTF) laws.</li>
                </ul>

                <h3 class="font-semibold text-lg">4. Fees and Exchange Rates</h3>
                <p>Our fees and exchange rates are clearly displayed before you confirm any transaction. By initiating a transfer, you agree to the applied fees and exchange rates. We reserve the right to change our fees and exchange rates at any time without prior notice, though changes will not affect transactions already in progress.</p>

                <h3 class="font-semibold text-lg">5. Transaction Limits</h3>
                <p>We may impose limits on the amount of money you can send or receive through our Service. These limits may vary based on your verification status, payout method, and other factors. We reserve the right to change these limits at our discretion.</p>

                <h3 class="font-semibold text-lg">6. Prohibited Activities</h3>
                <p>You agree not to use the Service for any illegal, fraudulent, or unauthorized purposes, including but not limited to:</p>
                <ul class="list-disc list-inside space-y-1 ml-4">
                    <li>Money laundering or terrorist financing.</li>
                    <li>Funding illegal activities.</li>
                    <li>Sending money on behalf of a third party without proper authorization.</li>
                    <li>Sending money to yourself to circumvent foreign exchange controls.</li>
                </ul>

                <h3 class="font-semibold text-lg">7. Disclaimer of Warranties</h3>
                <p>The Service is provided "as is" and "as available" without any warranties of any kind, either express or implied, including, but not limited to, implied warranties of merchantability, fitness for a particular purpose, or non-infringement.</p>

                <h3 class="font-semibold text-lg">8. Limitation of Liability</h3>
                <p>In no event shall Tumira, its directors, employees, or agents be liable for any indirect, incidental, special, consequential, or punitive damages, including without limitation, loss of profits, data, use, goodwill, or other intangible losses, resulting from (i) your access to or use of or inability to access or use the Service; (ii) any conduct or content of any third party on the Service; (iii) any content obtained from the Service; and (iv) unauthorized access, use or alteration of your transmissions or content, whether based on warranty, contract, tort (including negligence) or any other legal theory, whether or not we have been informed of the possibility of such damage, and even if a remedy set forth herein is found to have failed of its essential purpose.</p>

                <h3 class="font-semibold text-lg">9. Governing Law</h3>
                <p>These Terms shall be governed and construed in accordance with the laws of [Your Jurisdiction, e.g., Delaware, USA], without regard to its conflict of law provisions.</p>

                <h3 class="font-semibold text-lg">10. Changes to Terms</h3>
                <p>We reserve the right, at our sole discretion, to modify or replace these Terms at any time. If a revision is material, we will provide at least 30 days' notice prior to any new terms taking effect. What constitutes a material change will be determined at our sole discretion.</p>

                <p>By continuing to access or use our Service after those revisions become effective, you agree to be bound by the revised terms. If you do not agree to the new terms, please stop using the Service.</p>

                <h3 class="font-semibold text-lg">Contact Us</h3>
                <p>If you have any questions about these Terms, please contact us at support@tumira.com.</p>
            </div>
        </div>
    </div>

    <script type="module">
        // Ensure Firebase variables are accessible in this script
        const firebaseApp = window.firebaseApp;
        const db = window.db;
        const auth = window.auth;
        const appId = window.appId; // This appId is now derived from firebaseConfig.appId

        // Get references to elements
        const form = document.getElementById('remittanceForm');
        const payoutMethodSelect = document.getElementById('payoutMethod');
        const bankDetailsDiv = document.getElementById('bankDetails');
        const amountSendInput = document.getElementById('amountSend');
        const amountReceiveInput = document.getElementById('amountReceive');
        const responseMessageDiv = document.getElementById('responseMessage');

        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        const authForm = document.getElementById('authForm'); // Get the auth form container
        const accountNameInput = document.getElementById('accountName');
        const accountEmailInput = document.getElementById('accountEmail');
        const accountPasswordInput = document.getElementById('accountPassword');
        const createAccountBtn = document.getElementById('createAccountBtn');
        const loginAccountBtn = document.getElementById('loginAccountBtn');
        const accountMessageDiv = document.getElementById('accountMessage');
        const authSpinner = document.getElementById('authSpinner');
        const logoutButton = document.getElementById('logoutButton');

        const termsModal = document.getElementById('termsModal');
        const viewTermsLink = document.getElementById('viewTermsLink');
        const closeTermsModalBtn = document.getElementById('closeTermsModal');

        const toggleRemittanceFormBtn = document.getElementById('toggleRemittanceFormBtn');
        const sendMoneySection = document.getElementById('sendMoneySection'); // Parent div for remittance form & its button

        const toggleEstimateFeesFormBtn = document.getElementById('toggleEstimateFeesFormBtn');
        const feeEstimationForm = document.getElementById('feeEstimationForm');
        const estimateAmountInput = document.getElementById('estimateAmount');
        const estimatePayoutMethodSelect = document.getElementById('estimatePayoutMethod');
        const estimatedResultDiv = document.getElementById('estimatedResult');
        const estimateFeesSection = document.getElementById('estimateFeesSection');

        // New elements for profile management
        const manageProfileSection = document.getElementById('manageProfileSection');
        const updateProfileNameInput = document.getElementById('updateProfileName');
        const updateProfileBtn = document.getElementById('updateProfileBtn');
        const profileUpdateMessage = document.getElementById('profileUpdateMessage');
        const profileSpinner = document.getElementById('profileSpinner');

        const currentPasswordInput = document.getElementById('currentPassword');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmNewPasswordInput = document.getElementById('confirmNewPassword');
        const changePasswordBtn = document.getElementById('changePasswordBtn');
        const passwordChangeMessage = document.getElementById('passwordChangeMessage');
        const passwordSpinner = document.getElementById('passwordSpinner');


        // Helper function to display messages
        function displayMessage(element, message, type) {
            element.textContent = message;
            element.classList.remove('error-message', 'success-message');
            // Remove previous type classes
            element.classList.forEach(className => {
                if (className.includes('-message')) {
                    element.classList.remove(className);
                }
            });

            if (type === 'error') {
                element.classList.add('error-message');
            } else if (type === 'success') {
                element.classList.add('success-message');
            } else { // Neutral/info message
                element.classList.add('message-box');
            }
            element.style.display = 'block';
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000); // Hide after 5 seconds
        }

        // Function to show/hide bank details based on payout method
        payoutMethodSelect.addEventListener('change', function() {
            if (this.value === 'bank_transfer') {
                bankDetailsDiv.classList.remove('hidden');
                document.getElementById('bankName').setAttribute('required', 'required');
                document.getElementById('accountNumber').setAttribute('required', 'required');
            } else {
                bankDetailsDiv.classList.add('hidden');
                document.getElementById('bankName').removeAttribute('required');
                document.getElementById('accountNumber').removeAttribute('required');
            }
            // Recalculate amount receive when payout method changes
            updateAmountReceive();
        });

        // Exchange rate calculation (for demonstration)
        // Note: In a real app, this would come from a secure backend API.
        const exchangeRates = {
            'ZWL': 3000, // Example: 1 USD = 3000 ZWL
            'USD': 1     // 1 USD = 1 USD (for bank transfer/cash pickup in USD)
        };
        const fixedFee = 3.00; // Example fixed fee

        function calculateReceivedAmount(amountUSD, payoutMethod) {
            if (isNaN(amountUSD) || amountUSD <= 0) {
                return { amount: 0, currency: 'N/A' };
            }

            const netAmount = amountUSD - fixedFee;
            if (netAmount <= 0) {
                return { amount: 0, currency: 'Too Low' };
            }

            let receivedAmount;
            let currency;

            if (payoutMethod === 'bank_transfer') {
                receivedAmount = netAmount;
                currency = 'USD';
            } else if (payoutMethod === 'mobile_money') {
                receivedAmount = netAmount * exchangeRates['ZWL'];
                currency = 'ZWL';
            } else if (payoutMethod === 'cash_pickup') {
                // Assuming cash pickup can be USD or ZWL, defaulting to USD for simplicity
                // In a real scenario, you might have an option for recipient to choose
                receivedAmount = netAmount;
                currency = 'USD';
            } else {
                return { amount: 0, currency: 'N/A' };
            }
            return { amount: receivedAmount, currency: currency };
        }

        function updateAmountReceive() {
            const amountUSD = parseFloat(amountSendInput.value);
            const payoutMethod = payoutMethodSelect.value;
            const result = calculateReceivedAmount(amountUSD, payoutMethod);

            if (result.currency === 'Too Low') {
                amountReceiveInput.value = 'Amount too low after fee';
            } else if (result.currency === 'N/A') {
                amountReceiveInput.value = 'Select payout method';
            } else {
                amountReceiveInput.value = `${result.amount.toFixed(2)} ${result.currency}`;
            }
        }

        amountSendInput.addEventListener('input', updateAmountReceive);
        // Initial calculation on load
        updateAmountReceive();


        // Fee Estimation Logic
        function updateEstimatedFees() {
            const amount = parseFloat(estimateAmountInput.value);
            const payoutMethod = estimatePayoutMethodSelect.value;
            const result = calculateReceivedAmount(amount, payoutMethod);

            if (result.currency === 'Too Low') {
                displayMessage(estimatedResultDiv, 'The amount is too low after considering the fixed fee ($3.00).', 'error');
            } else if (result.currency === 'N/A' || isNaN(amount) || amount <= 0 || !payoutMethod) {
                estimatedResultDiv.style.display = 'none'; // Hide if inputs are invalid/empty
            } else {
                const fee = fixedFee;
                displayMessage(estimatedResultDiv, `Sending $${amount.toFixed(2)} USD will incur a fee of $${fee.toFixed(2)} USD. Your recipient will receive approximately ${result.amount.toFixed(2)} ${result.currency}.`, 'success');
            }
        }

        estimateAmountInput.addEventListener('input', updateEstimatedFees);
        estimatePayoutMethodSelect.addEventListener('change', updateEstimatedFees);


        // Toggle Remittance Form Visibility
        toggleRemittanceFormBtn.addEventListener('click', () => {
            if (form.classList.contains('hidden')) {
                form.classList.remove('hidden');
                toggleRemittanceFormBtn.textContent = 'Hide Send Money Form';
            } else {
                form.classList.add('hidden');
                toggleRemittanceFormBtn.textContent = 'Send Money';
            }
        });

        // Toggle Estimate Fees Form Visibility
        toggleEstimateFeesFormBtn.addEventListener('click', () => {
            if (feeEstimationForm.classList.contains('hidden')) {
                feeEstimationForm.classList.remove('hidden');
                toggleEstimateFeesFormBtn.textContent = 'Hide Fee Estimator';
                updateEstimatedFees(); // Run estimation when shown
            } else {
                feeEstimationForm.classList.add('hidden');
                toggleEstimateFeesFormBtn.textContent = 'Estimate Fees';
                estimatedResultDiv.style.display = 'none'; // Hide result when form is hidden
            }
        });


        // Handle form submission for remittance
        form.addEventListener('submit', async function(event) {
            event.preventDefault(); // Prevent default form submission

            if (!window.isAuthReady || !auth.currentUser) {
                displayMessage(responseMessageDiv, 'Please kindly log in or create an account to proceed with sending money. Thank you!', 'error');
                return;
            }

            const formData = {
                senderName: document.getElementById('senderName').value,
                senderPhone: document.getElementById('senderPhone').value,
                senderEmail: document.getElementById('senderEmail').value,
                recipientName: document.getElementById('recipientName').value,
                recipientPhone: document.getElementById('recipientPhone').value,
                payoutMethod: document.getElementById('payoutMethod').value,
                bankName: document.getElementById('bankName').value,
                accountNumber: document.getElementById('accountNumber').value,
                amountSend: parseFloat(document.getElementById('amountSend').value),
                amountReceive: amountReceiveInput.value, // This includes currency (e.g., "300000.00 ZWL")
                purpose: document.getElementById('purpose').value,
                userId: auth.currentUser.uid, // Associate with current user
                timestamp: new Date().toISOString() // Store timestamp as ISO string
            };

            // Basic validation check for required fields before proceeding
            const requiredFields = ['senderName', 'senderPhone', 'recipientName', 'recipientPhone', 'payoutMethod', 'amountSend'];
            let allFieldsFilled = true;
            for (const fieldId of requiredFields) {
                const field = document.getElementById(fieldId);
                if (!field.value) {
                    allFieldsFilled = false;
                    field.classList.add('border-red-500'); // Highlight missing field
                } else {
                    field.classList.remove('border-red-500');
                }
            }
            if (formData.payoutMethod === 'bank_transfer') {
                if (!formData.bankName || !formData.accountNumber) {
                    allFieldsFilled = false;
                    if (!formData.bankName) document.getElementById('bankName').classList.add('border-red-500');
                    if (!formData.accountNumber) document.getElementById('accountNumber').classList.add('border-red-500');
                } else {
                    document.getElementById('bankName').classList.remove('border-red-500');
                    document.getElementById('accountNumber').classList.remove('border-red-500');
                }
            }

            if (!allFieldsFilled) {
                displayMessage(responseMessageDiv, 'Please fill in all the required fields before submitting your transfer. Thank you!', 'error');
                return;
            }
            if (formData.amountSend <= fixedFee) {
                 displayMessage(responseMessageDiv, `The amount to send must be greater than the fixed fee ($${fixedFee.toFixed(2)}). Please adjust your amount.`, 'error');
                 return;
             }


            displayMessage(responseMessageDiv, 'Processing your transfer... Please wait kindly.', 'message-box'); // Show a neutral message initially

            // In a real application, you would send this formData to your backend API here
            // For this demo, we'll simulate a successful response after a short delay
            console.log('Attempting to send money with data:', formData);

            try {
                // Simulate API call delay
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Save transaction to Firestore (optional, for demo tracking)
                // In a real system, transactions would be managed by a secure backend
                if (db && auth.currentUser) {
                    const transactionsCollectionRef = window.collection(db, `artifacts/${appId}/users/${auth.currentUser.uid}/transactions`);
                    const transactionDocRef = window.doc(transactionsCollectionRef); // Auto-generate document ID
                    await window.setDoc(transactionDocRef, formData);
                    console.log("Transaction saved to Firestore:", transactionDocRef.id);
                }

                displayMessage(responseMessageDiv, 'Wonderful! Your transfer request has been initiated successfully. We will notify you once its complete!', 'success');
                form.reset(); // Clear form fields
                updateAmountReceive(); // Reset calculated amount display
                bankDetailsDiv.classList.add('hidden'); // Hide bank details if they were shown
                form.classList.add('hidden'); // Hide the form after successful submission
                toggleRemittanceFormBtn.textContent = 'Send Money'; // Reset button text
            } catch (error) {
                console.error('Error initiating transfer:', error);
                displayMessage(responseMessageDiv, `Oops! Something went wrong while initiating your transfer: ${error.message}. Please try again shortly.`, 'error');
            }
        });

        // Tab switching logic
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetTab = button.dataset.tab;

                // Deactivate all tabs and content
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));

                // Activate clicked tab and its content
                button.classList.add('active');
                document.getElementById(targetTab).classList.add('active');
            });
        });

        // Firebase Auth Functions
        async function handleCreateAccount() {
            const email = accountEmailInput.value;
            const password = accountPasswordInput.value;
            const name = accountNameInput.value; // Get the name from input

            if (!email || !password || password.length < 6) {
                displayMessage(accountMessageDiv, 'Please enter a valid email and a password of at least 6 characters. Thank you!', 'error');
                return;
            }

            authSpinner.style.display = 'block';
            accountMessageDiv.style.display = 'none';

            try {
                const userCredential = await window.createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                console.log("User created:", user.uid);

                // Save user profile to Firestore
                const userProfileRef = window.doc(db, `artifacts/${appId}/users/${user.uid}/profiles`, 'userProfile');
                await window.setDoc(userProfileRef, {
                    name: name,
                    email: email,
                    createdAt: new Date().toISOString()
                });
                console.log("User profile saved for:", user.uid);
                displayMessage(accountMessageDiv, 'Fantastic! Your account has been successfully created and you are now logged in. Welcome to Tumira!', 'success');
                accountNameInput.value = ''; // Clear fields
                accountEmailInput.value = '';
                accountPasswordInput.value = '';
            } catch (error) {
                console.error("Error creating account:", error);
                let errorMessage = 'An unexpected error occurred. Please try again.';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'This email is already registered. Please try logging in or use a different email.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'The password is too weak. Please choose a stronger password.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'The email address is not valid.';
                }
                displayMessage(accountMessageDiv, `We encountered an issue: ${errorMessage} Please try again.`, 'error');
            } finally {
                authSpinner.style.display = 'none';
            }
        }

        async function handleLogin() {
            const email = accountEmailInput.value;
            const password = accountPasswordInput.value;

            if (!email || !password) {
                displayMessage(accountMessageDiv, 'Please enter both your email and password to log in. Thank you!', 'error');
                return;
            }

            authSpinner.style.display = 'block';
            accountMessageDiv.style.display = 'none';

            try {
                await window.signInWithEmailAndPassword(auth, email, password);
                console.log("User logged in successfully.");
                displayMessage(accountMessageDiv, 'Welcome back! You have successfully logged in. We are delighted to see you.', 'success');
                accountEmailInput.value = ''; // Clear fields
                accountPasswordInput.value = '';
            } catch (error) {
                console.error("Error logging in:", error);
                let errorMessage = 'An unexpected error occurred. Please try again.';
                if (error.code === 'auth/invalid-credential') {
                    errorMessage = 'The email or password you entered is incorrect. Please double-check and try again.';
                } else if (error.code === 'auth/user-not-found') {
                    errorMessage = 'No user found with this email. Please consider creating an account.';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'The password you entered is incorrect. Please try again.';
                }
                displayMessage(accountMessageDiv, `We encountered an issue: ${errorMessage} Please try again.`, 'error');
            } finally {
                authSpinner.style.display = 'none';
            }
        }

        async function handleLogout() {
            try {
                await window.signOut(auth);
                console.log("User logged out.");
                displayMessage(accountMessageDiv, 'You have been successfully logged out. We look forward to seeing you again soon!', 'success');
                // Ensure auth section is visible and user info section is hidden
                // This state is also handled by the onAuthStateChanged listener
            } catch (error) {
                console.error("Error logging out:", error);
                displayMessage(accountMessageDiv, `We couldn't log you out right now: ${error.message}. Please try again.`, 'error');
            }
        }

        // Attach event listeners for auth buttons
        createAccountBtn.addEventListener('click', handleCreateAccount);
        loginAccountBtn.addEventListener('click', handleLogin);
        logoutButton.addEventListener('click', handleLogout);


        // Profile Update Functionality
        updateProfileBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) {
                displayMessage(profileUpdateMessage, 'You must be logged in to update your profile.', 'error');
                return;
            }

            const newName = updateProfileNameInput.value.trim();
            if (!newName) {
                displayMessage(profileUpdateMessage, 'Please enter a valid name.', 'error');
                return;
            }

            profileSpinner.style.display = 'block';
            profileUpdateMessage.style.display = 'none';

            try {
                // Update Firebase Auth profile
                await window.updateProfile(user, { displayName: newName });

                // Update Firestore user profile
                const userProfileRef = window.doc(db, `artifacts/${appId}/users/${user.uid}/profiles`, 'userProfile');
                await window.setDoc(userProfileRef, { name: newName }, { merge: true });

                displayMessage(profileUpdateMessage, 'Your profile name has been updated successfully!', 'success');
                // Refresh the displayed name on the home tab
                document.getElementById('displayUserName').textContent = newName;
            } catch (error) {
                console.error("Error updating profile:", error);
                displayMessage(profileUpdateMessage, `Failed to update profile: ${error.message}`, 'error');
            } finally {
                profileSpinner.style.display = 'none';
            }
        });

        // Password Change Functionality
        changePasswordBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) {
                displayMessage(passwordChangeMessage, 'You must be logged in to change your password.', 'error');
                return;
            }

            const currentPassword = currentPasswordInput.value;
            const newPassword = newPasswordInput.value;
            const confirmNewPassword = confirmNewPasswordInput.value;

            if (!currentPassword || !newPassword || !confirmNewPassword) {
                displayMessage(passwordChangeMessage, 'Please fill in all password fields.', 'error');
                return;
            }
            if (newPassword !== confirmNewPassword) {
                displayMessage(passwordChangeMessage, 'New password and confirmation do not match.', 'error');
                return;
            }
            if (newPassword.length < 6) {
                displayMessage(passwordChangeMessage, 'New password must be at least 6 characters long.', 'error');
                return;
            }

            passwordSpinner.style.display = 'block';
            passwordChangeMessage.style.display = 'none';

            try {
                // Reauthenticate user before changing password
                const credential = window.EmailAuthProvider.credential(user.email, currentPassword);
                await window.reauthenticateWithCredential(user, credential);

                // Update password
                await window.updatePassword(user, newPassword);

                displayMessage(passwordChangeMessage, 'Your password has been changed successfully!', 'success');
                currentPasswordInput.value = '';
                newPasswordInput.value = '';
                confirmNewPasswordInput.value = '';
            } catch (error) {
                console.error("Error changing password:", error);
                let errorMessage = 'Failed to change password. Please try again.';
                if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Your current password is incorrect.';
                } else if (error.code === 'auth/requires-recent-login') {
                    errorMessage = 'Please log out and log in again to change your password (for security reasons).';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'The new password is too weak. Please choose a stronger one.';
                }
                displayMessage(passwordChangeMessage, `${errorMessage} Error: ${error.message}`, 'error');
            } finally {
                passwordSpinner.style.display = 'none';
            }
        });

        // Terms and Conditions Modal Logic
        viewTermsLink.addEventListener('click', function(e) {
            e.preventDefault(); // Prevent default link behavior
            termsModal.classList.add('active');
        });

        closeTermsModalBtn.addEventListener('click', function() {
            termsModal.classList.remove('active');
        });

        // Close modal if user clicks outside the content
        termsModal.addEventListener('click', function(e) {
            if (e.target === termsModal) {
                termsModal.classList.remove('active');
            }
        });

        // Set initial active tab to 'home'
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelector('.tab-button[data-tab="home"]').click();
        });
    </script>
</body>
</html>
